---
output: rmarkdown::github_document
always_allow_html: true
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

[![Website - pkgdown](https://img.shields.io/badge/data-visulaization-blue)](https://tillrose.github.io/BRIWECS_Data_Publication/data_overview.html) [![Project-website](https://img.shields.io/badge/Project-website-darkgreen)](https://www.igps.uni-hannover.de/de/forschung/forschungsprojekte/detailansicht/projects/forschungsverbund-briwecs)

![Breeding Innovations in Wheat for Efficient Cropping Systems (BRIWECS).](https://github.com/tillrose/BRIWECS_Data_Publication/blob/main/figure/BRIWECS_logo.png){fig-align="right"}

## A collaborative work on a data publication for the seasons 2015â€“2019 of the BRIWECS consortium

<!-- [![License: GPL-3](https://img.shields.io/badge/License-GPL3-orange)](https://www.r-project.org/Licenses/) -->

```{r setup, include=FALSE,echo=F}
knitr::opts_chunk$set(echo = TRUE)
suppressWarnings(library(dplyr));
# suppressWarnings(library(ggplot2));
library(kableExtra);library(knitr);library(toolPhD)
# library(data.tree);
library(igraph)
suppressWarnings(library(tidygraph))
suppressWarnings(library(ggraph))
options(dplyr.summarise.inform = FALSE)
unit<- xlsx::read.xlsx("./metadata/Unit.xlsx",sheetIndex = 1) %>%
  mutate(unit=gsub('\\#','Nbr ',unit),
         unit=gsub('\\*',' x ',unit),
         unit=ifelse(is.na(unit),' ',unit),
         Full.name=gsub("caused.*","",Full.name,perl=T)
         ) %>% select(-trait_old,-abbrev)

raw <- read.csv2("./output/BRIWECS_data_publication.csv") %>% 
  mutate(across(BBCH59:Protein_yield,as.numeric))
long <- raw  %>% 
  tidyr::pivot_longer(BBCH59:Protein_yield,
                      names_to="trait",values_to = "Trait") %>% 
  filter(!is.na(Trait)) 
tbl <- long %>%
left_join(unit ,by='trait')%>%
  view_group(.,"trait",c('Full.name',"sample.source","Trait","unit")) %>% 
  arrange(sample.source,trait) %>% 
  relocate(Full.name,sample.source) %>% 
  rename("trait full name"="Full.name","trait name in\ndata descriptor"="trait",
         "trait source"="sample.source","trait range"="Trait") 

```

## previous publications

[![Voss-Fels 2019](https://github.com/tillrose/BRIWECS_Data_Publication/blob/main/figure/previous_paper/Kai2019.PNG){#fig-kai .lightbox width="160" height="220"}](https://www.nature.com/articles/s41477-019-0445-5) [![Rose 2019](https://github.com/tillrose/BRIWECS_Data_Publication/blob/main/figure/previous_paper/Rose_2019.png){#fig-till width="160" height="220"}](https://www.frontiersin.org/journals/plant-science/articles/10.3389/fpls.2019.01521/full) [![Lichthardt 2020](https://github.com/tillrose/BRIWECS_Data_Publication/blob/main/figure/previous_paper/Carolin_2020.png){#fig-carolin width="160" height="220"}](https://www.frontiersin.org/journals/plant-science/articles/10.3389/fpls.2019.01771/full) [![Zetzsche 2020](https://github.com/tillrose/BRIWECS_Data_Publication/blob/main/figure/previous_paper/Zetzsche_2020.png){#fig-holger width="160" height="220"}](https://www.nature.com/articles/s41598-020-77200-0) [![Sabir 2023](https://github.com/tillrose/BRIWECS_Data_Publication/blob/main/figure/previous_paper/Sabir_2023.png){#fig-kahdija width="160" height="220"}](https://www.nature.com/articles/s41477-023-01516-8)

## insturctution

1.  open `BRIWECS_Data_Publication.RProject`
2.  open `scripts/run.R`
3.  run all `Ctrl + Alt + R` ![](https://github.com/tillrose/BRIWECS_Data_Publication/blob/main/figure/Instruction.PNG){fig-align="center"}

## directory tree

```{r,echo=F,fig.width=10, fig.height=10,warning=F}
dirs <- list.dirs(path = ".", full.names = TRUE, recursive = TRUE) 

r.target <- paste(c(".git",".Rproj.user",".quarto","gfm","docs"),
                  collapse='|')
dirs <- dirs[!grepl(r.target,dirs)]

e.target <- c("./data","./figure",
              "./metadata","./output","./scripts")
dirs <- 
  purrr::map(e.target,~{
    list.files(.x,all.files = T,recursive = T,full.names = T)
  }) %>% Reduce(x = .,"c")  %>% 
  c(.,dirs)

dirst <- gsub("\\.\\/","Root/",dirs)

x <- lapply(strsplit(dirst, "/"), 
            function(z) as.data.frame(t(z))) %>% 
  plyr::rbind.fill(.) %>%
  filter(!is.na(V2)) %>% 
  group_by(V1,V2,V3) %>%
  reframe(V4 = case_when(n() > 5&(!V3=="pre-processing")~sprintf("%s files",n()-1),
                           T~V4)) %>% 
  mutate(V2=factor(V2,levels=c("data","metadata","scripts","output","figure"))) %>% 
  arrange(desc(V2)) %>% suppressWarnings()

x$pathString <- apply(x, 1, function(x) paste(trimws(na.omit(x)), collapse="/"))

do.call('rbind', 
        strsplit(x$pathString, '/') %>%
  lapply(function(a) sapply(seq_along(a),
                            function(y) paste(a[1:y], collapse = '/'))) %>% 
  lapply(function(b) cbind(head(b, -1), tail(b, -1)))
) %>% 
  as.data.frame() %>%
  unique() %>%
  graph_from_data_frame() %>%
  as_tbl_graph() %>%
  mutate(label = gsub('^.*/(.*)$', '\\1', name)) %>%
  ggraph(layout = 'tree') + 
  geom_edge_diagonal(color = 'gray') +
  geom_node_point(shape = 21, size=5,fill = 'orange') +
  geom_node_text(aes(label = label), size = 4, nudge_x = 0.5) +
  coord_flip(clip = 'off') +
  scale_y_reverse() +
  theme_graph()

```

## trait table

```{r,echo=F}
tbl%>%
  kbl(caption = "Table 1. Trait names, sources, ranges and units") %>%
  kable_classic_2(full_width = F, position = "float_right")
```

## overview visualizations

![Fig0. Experiments location and soil properties.](https://github.com/tillrose/BRIWECS_Data_Publication/blob/main/figure/fig0.png){fig-align="center"}

![Fig1. An overview of MET data descriptor of winter wheat containing 24 traits collected across six locations in Germany (GGE, HAN, KAL, KIE, QLB, RHH) with nine managements (HN_WF_RO, LN_NF_IR, HN_NF_IR, HN_WF_IR, HN_WF_RF, LN_WF_IR, HN_NF_RF, LN_NF_RF and LN_WF_RF) during six years (2015-2020).](https://github.com/tillrose/BRIWECS_Data_Publication/blob/main/figure/fig1.png){fig-align="center"}

![Fig2.Scatter plot of 29 combinations of location by year by management (LxYxM) versus 228 genotypes for 24 traits.](https://github.com/tillrose/BRIWECS_Data_Publication/blob/main/figure/data_point.png){fig-align="center"}
